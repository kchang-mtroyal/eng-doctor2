<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ æ‹¿å¤§éŠ€é«®æ—é†«ç™‚è‹±èªé€š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .btn-active:active { transform: scale(0.95); transition: transform 0.1s; }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Global Cache ---
        const ttsCache = {}; 
        let apiRateLimitedUntil = 0; 

        // --- Data: Curriculum ---
        const LEVELS = {
            1: {
                id: 1, title: "Level 1: å ±åˆ°èˆ‡åŸºç¤", subTitle: "Check-in & Basics", color: "bg-orange-500",
                vocab: [
                    { en: "Appointment", kk: "/É™'pÉ”ÉªntmÉ™nt/", cn: "é ç´„", category: "æ›è™Ÿ" },
                    { en: "Name", kk: "/nem/", cn: "åå­—", category: "å€‹è³‡" },
                    { en: "ID card", kk: "/ËŒaÉª 'di kÉ‘rd/", cn: "è­‰ä»¶/å¥ä¿å¡", category: "å€‹è³‡" },
                    { en: "Form", kk: "/fÉ”rm/", cn: "è¡¨æ ¼", category: "æ›è™Ÿ" },
                    { en: "Wait", kk: "/wet/", cn: "ç­‰å¾…", category: "å‹•ä½œ" },
                    { en: "Doctor", kk: "/'dÉ‘ktÉš/", cn: "é†«ç”Ÿ", category: "äººç‰©" },
                    { en: "Nurse", kk: "/nÉs/", cn: "è­·ç†å¸«", category: "äººç‰©" },
                    { en: "Speak", kk: "/spik/", cn: "èªª", category: "æºé€š" },
                    { en: "Chinese", kk: "/tÊƒaÉª'niz/", cn: "ä¸­æ–‡", category: "æºé€š" },
                    { en: "Help", kk: "/hÉ›lp/", cn: "å¹«å¿™", category: "é€šç”¨" }
                ],
                sentences: [
                    { en: "I have an appointment.", cn: "æˆ‘æœ‰é ç´„ã€‚", context: "æ›è™Ÿæ«ƒå°" },
                    { en: "My name is [Name].", cn: "æˆ‘çš„åå­—æ˜¯...", context: "å ±åˆ°" },
                    { en: "Here is my ID card.", cn: "é€™æ˜¯æˆ‘çš„è­‰ä»¶ã€‚", context: "å ±åˆ°" },
                    { en: "I need a doctor.", cn: "æˆ‘éœ€è¦çœ‹é†«ç”Ÿã€‚", context: "æ±‚åŠ©" },
                    { en: "I don't speak English.", cn: "æˆ‘ä¸å¤ªæœƒèªªè‹±æ–‡ã€‚", context: "æºé€š" },
                    { en: "Do you speak Chinese?", cn: "ä½ æœƒèªªä¸­æ–‡å—ï¼Ÿ", context: "æºé€š" },
                    { en: "Can you help me?", cn: "å¯ä»¥å¹«æˆ‘å—ï¼Ÿ", context: "æ±‚åŠ©" },
                    { en: "Where is the restroom?", cn: "æ´—æ‰‹é–“åœ¨å“ªè£¡ï¼Ÿ", context: "è©¢å•" },
                    { en: "Please speak slowly.", cn: "è«‹èªªæ…¢ä¸€é»ã€‚", context: "æºé€š" },
                    { en: "Thank you very much.", cn: "éå¸¸è¬è¬ä½ ã€‚", context: "ç¦®è²Œ" }
                ]
            },
            2: {
                id: 2, title: "Level 2: å¸¸è¦‹ç—‡ç‹€", subTitle: "Common Symptoms", color: "bg-emerald-600",
                vocab: [
                    { en: "Pain", kk: "/pen/", cn: "ç—›", category: "æ„Ÿè¦º" },
                    { en: "Headache", kk: "/'hÉ›dËŒek/", cn: "é ­ç—›", category: "ç—‡ç‹€" },
                    { en: "Stomachache", kk: "/'stÊŒmÉ™kËŒek/", cn: "èƒƒç—›", category: "ç—‡ç‹€" },
                    { en: "Fever", kk: "/'fivÉš/", cn: "ç™¼ç‡’", category: "ç—‡ç‹€" },
                    { en: "Cough", kk: "/kÉ”f/", cn: "å’³å—½", category: "ç—‡ç‹€" },
                    { en: "Dizzy", kk: "/'dÉªzi/", cn: "é ­æšˆ", category: "æ„Ÿè¦º" },
                    { en: "Nausea", kk: "/'nÉ”zÉªÉ™/", cn: "æƒ³å/å™å¿ƒ", category: "ç—‡ç‹€" },
                    { en: "Itchy", kk: "/'ÉªtÊƒÉª/", cn: "ç™¢", category: "æ„Ÿè¦º" },
                    { en: "Cold", kk: "/kold/", cn: "æ„Ÿå†’/å†·", category: "ç—‡ç‹€" },
                    { en: "Hurt", kk: "/hÉt/", cn: "å—å‚·/ç—›", category: "æ„Ÿè¦º" }
                ],
                sentences: [
                    { en: "I have a headache.", cn: "æˆ‘é ­ç—›ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I have a stomachache.", cn: "æˆ‘èƒƒç—›(è‚šå­ç—›)ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I have a fever.", cn: "æˆ‘ç™¼ç‡’äº†ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I feel dizzy.", cn: "æˆ‘è¦ºå¾—é ­æšˆã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I want to vomit.", cn: "æˆ‘æƒ³åã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "My chest hurts.", cn: "æˆ‘èƒ¸å£ç—›ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "My leg hurts.", cn: "æˆ‘è…¿ç—›ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "It hurts right here.", cn: "å°±æ˜¯é€™è£¡ç—›(æŒ‡è‘—éƒ¨ä½)ã€‚", context: "æŒ‡å‡ºç—›é»" },
                    { en: "I have a bad cough.", cn: "æˆ‘å’³å¾—å¾ˆå²å®³ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I cannot sleep.", cn: "æˆ‘ç¡ä¸è‘—ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "I have diarrhea.", cn: "æˆ‘æ‹‰è‚šå­ã€‚", context: "æè¿°ç—…æƒ…" },
                    { en: "It started yesterday.", cn: "æ˜¨å¤©é–‹å§‹çš„ã€‚", context: "ç™¼ç—…æ™‚é–“" },
                    { en: "It started 3 days ago.", cn: "ä¸‰å¤©å‰é–‹å§‹çš„ã€‚", context: "ç™¼ç—…æ™‚é–“" },
                    { en: "It hurts a lot.", cn: "éå¸¸ç—›ã€‚", context: "ç–¼ç—›ç¨‹åº¦" },
                    { en: "It hurts a little.", cn: "æœ‰ä¸€é»ç—›ã€‚", context: "ç–¼ç—›ç¨‹åº¦" }
                ]
            },
            3: {
                id: 3, title: "Level 3: é†«ç”Ÿå•è¨ºèˆ‡ç—…å²", subTitle: "Doctor Q&A", color: "bg-blue-600",
                vocab: [
                    { en: "High blood pressure", kk: "/haÉª blÊŒd 'prÉ›ÊƒÉš/", cn: "é«˜è¡€å£“", category: "ç—…å²" },
                    { en: "Diabetes", kk: "/ËŒdaÉªÉ™'bitiz/", cn: "ç³–å°¿ç—…", category: "ç—…å²" },
                    { en: "Allergy", kk: "/'Ã¦lÉšdÊ’Éª/", cn: "éæ•", category: "ç—…å²" },
                    { en: "Medicine", kk: "/'mÉ›dÉ™sn/", cn: "è—¥ç‰©", category: "æ²»ç™‚" },
                    { en: "Pregnant", kk: "/'prÉ›gnÉ™nt/", cn: "æ‡·å­•", category: "ç‹€æ³" },
                    { en: "Surgery", kk: "/'sÉdÊ’É™rÉª/", cn: "æ‰‹è¡“", category: "ç—…å²" },
                    { en: "Blood test", kk: "/blÊŒd tÉ›st/", cn: "é©—è¡€", category: "æª¢æŸ¥" },
                    { en: "X-ray", kk: "/'É›ksËŒre/", cn: "Xå…‰", category: "æª¢æŸ¥" }
                ],
                sentences: [
                    { en: "I have high blood pressure.", cn: "æˆ‘æœ‰é«˜è¡€å£“ã€‚", context: "å‘ŠçŸ¥ç—…å²" },
                    { en: "I have diabetes.", cn: "æˆ‘æœ‰ç³–å°¿ç—…ã€‚", context: "å‘ŠçŸ¥ç—…å²" },
                    { en: "I have heart disease.", cn: "æˆ‘æœ‰å¿ƒè‡Ÿç—…ã€‚", context: "å‘ŠçŸ¥ç—…å²" },
                    { en: "I am allergic to seafood.", cn: "æˆ‘å°æµ·é®®éæ•ã€‚", context: "éæ•å²" },
                    { en: "I am allergic to penicillin.", cn: "æˆ‘å°ç›¤å°¼è¥¿æ—éæ•ã€‚", context: "éæ•å²" },
                    { en: "I am taking medicine.", cn: "æˆ‘æœ‰åœ¨åƒè—¥ã€‚", context: "ç”¨è—¥ç‹€æ³" },
                    { en: "No allergies.", cn: "æ²’æœ‰éæ•ã€‚", context: "å›ç­”é†«ç”Ÿ" },
                    { en: "No surgeries.", cn: "æ²’å‹•éæ‰‹è¡“ã€‚", context: "å›ç­”é†«ç”Ÿ" },
                    { en: "Does it hurt when I press?", cn: "(é†«ç”Ÿå•)æŒ‰é€™è£¡æœƒç—›å—ï¼Ÿ", context: "è½æ‡‚é†«ç”Ÿ" },
                    { en: "Yes, it hurts.", cn: "å°ï¼Œæœƒç—›ã€‚", context: "å›ç­”é†«ç”Ÿ" },
                    { en: "No, no pain there.", cn: "ä¸ï¼Œé‚£è£¡ä¸ç—›ã€‚", context: "å›ç­”é†«ç”Ÿ" },
                    { en: "Open your mouth.", cn: "(é†«ç”Ÿèªª) å¼µé–‹å˜´å·´ã€‚", context: "è½æ‡‚æŒ‡ä»¤" },
                    { en: "Take a deep breath.", cn: "(é†«ç”Ÿèªª) æ·±å‘¼å¸ã€‚", context: "è½æ‡‚æŒ‡ä»¤" }
                ]
            },
            4: {
                id: 4, title: "Level 4: è—¥å±€èˆ‡ç·Šæ€¥ç‹€æ³", subTitle: "Pharmacy & Emergency", color: "bg-red-600",
                vocab: [
                    { en: "Pharmacy", kk: "/'fÉ‘rmÉ™sÉª/", cn: "è—¥å±€", category: "åœ°é»" },
                    { en: "Prescription", kk: "/prÉª'skrÉªpÊƒÉ™n/", cn: "è™•æ–¹ç±¤", category: "è—¥ç‰©" },
                    { en: "Pill", kk: "/pÉªl/", cn: "è—¥ä¸¸", category: "è—¥ç‰©" },
                    { en: "Side effects", kk: "/saÉªd Éª'fÉ›kts/", cn: "å‰¯ä½œç”¨", category: "è—¥ç‰©" },
                    { en: "Emergency", kk: "/Éª'mÉdÊ’É™nsÉª/", cn: "ç·Šæ€¥ç‹€æ³", category: "ç·Šæ€¥" },
                    { en: "Ambulance", kk: "/'Ã¦mbjÉ™lÉ™ns/", cn: "æ•‘è­·è»Š", category: "ç·Šæ€¥" },
                    { en: "Hospital", kk: "/'hÉ‘spÉªt!/", cn: "é†«é™¢", category: "åœ°é»" },
                    { en: "Fall", kk: "/fÉ”l/", cn: "è·Œå€’", category: "æ„å¤–" }
                ],
                sentences: [
                    { en: "I need to fill a prescription.", cn: "æˆ‘è¦é ˜è™•æ–¹è—¥ã€‚", context: "è—¥å±€" },
                    { en: "I need a refill.", cn: "æˆ‘è¦çºŒè—¥(è—¥åƒå®Œäº†)ã€‚", context: "è—¥å±€" },
                    { en: "How many times a day?", cn: "ä¸€å¤©åƒå¹¾æ¬¡ï¼Ÿ", context: "è©¢å•è—¥å¸«" },
                    { en: "Take with food.", cn: "(è—¥å¸«èªª) éš¨é¤æœç”¨(é£¯å¾Œåƒ)ã€‚", context: "ç”¨è—¥æŒ‡ç¤º" },
                    { en: "Does this have side effects?", cn: "é€™æœ‰å‰¯ä½œç”¨å—ï¼Ÿ", context: "è©¢å•è—¥å¸«" },
                    { en: "Call an ambulance!", cn: "å«æ•‘è­·è»Šï¼", context: "ç·Šæ€¥" },
                    { en: "I fell down.", cn: "æˆ‘è·Œå€’äº†ã€‚", context: "ç·Šæ€¥" },
                    { en: "I cannot breathe.", cn: "æˆ‘ä¸èƒ½å‘¼å¸ã€‚", context: "ç·Šæ€¥" },
                    { en: "I am bleeding.", cn: "æˆ‘åœ¨æµè¡€ã€‚", context: "ç·Šæ€¥" },
                    { en: "Help me, please!", cn: "æ‹œè¨—æ•‘æ•‘æˆ‘ï¼", context: "ç·Šæ€¥" },
                    { en: "Where is the hospital?", cn: "é†«é™¢åœ¨å“ªè£¡ï¼Ÿ", context: "ç·Šæ€¥" },
                    { en: "I have insurance.", cn: "æˆ‘æœ‰ä¿éšªã€‚", context: "ç¹³è²»" }
                ]
            }
        };

        // --- Helpers ---
        function addWavHeader(pcmData, sampleRate = 24000, numChannels = 1) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const writeString = (view, offset, string) => { for (let i=0; i<string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.byteLength, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true); view.setUint16(32, numChannels * 2, true); view.setUint16(34, 16, true);
            writeString(view, 36, 'data'); view.setUint32(40, pcmData.byteLength, true);
            return new Blob([header, pcmData], { type: 'audio/wav' });
        }

        function speakWithBrowser(text, speed, lang = 'en-US') {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = speed;
            utterance.lang = lang;
            const voices = window.speechSynthesis.getVoices();
            let preferredVoice = null;
            if (lang === 'zh-TW') preferredVoice = voices.find(v => v.lang.includes("zh") || v.name.includes("Taiwan"));
            else preferredVoice = voices.find(v => v.name.includes("Google US") || v.name.includes("Samantha"));
            if (preferredVoice) utterance.voice = preferredVoice;
            window.speechSynthesis.speak(utterance);
        }

        async function fetchGeminiTTS(text, apiKey) {
            if (!apiKey) throw new Error("No API Key");
            if (Date.now() < apiRateLimitedUntil) throw new Error("RATE_LIMIT");
            if (ttsCache[text]) return ttsCache[text];
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } } })
                });
                if (response.status === 429) { apiRateLimitedUntil = Date.now() + 60000; throw new Error("RATE_LIMIT"); }
                const data = await response.json();
                const audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audio) throw new Error("NO_AUDIO");
                ttsCache[text] = audio;
                return audio;
            } catch (error) { throw error; }
        }

        const CURRICULUM_CONTEXT = Object.values(LEVELS).map(l => `Level ${l.id} (${l.subTitle}): ${l.sentences.map(s=>s.en).join(', ')}.`).join('\n');

        async function fetchGeminiChatResponse(history, apiKey) {
            if (Date.now() < apiRateLimitedUntil) return "ç³»çµ±å¿™ç¢Œä¸­ (System Busy)...";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = `Role: Warm bilingual (Traditional Chinese & English) Medical English Tutor for an elderly beginner in Canada.
            Curriculum: ${CURRICULUM_CONTEXT}
            Method: Chat naturally in Chinese mostly. Teach specific phrases from curriculum. Correct mistakes gently. Praise often.`;
            
            const contents = [{ role: "user", parts: [{ text: systemPrompt + "\n\nStart conversation." }] }, ...history.map(m => ({ role: m.role==='user'?'user':'model', parts: [{ text: m.text }] }))];
            try {
                const res = await fetch(url, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ contents }) });
                if (res.status === 429) { apiRateLimitedUntil = Date.now() + 60000; return "AI ä¼‘æ¯ä¸­..."; }
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œè«‹å†èªªä¸€æ¬¡ã€‚";
            } catch (e) { return "ç¶²è·¯é€£ç·šå•é¡Œã€‚"; }
        }

        async function fetchGeminiQuiz(levelInfo, apiKey) {
            if (Date.now() < apiRateLimitedUntil) return getFallbackQuiz(levelInfo);
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const randomSentence = levelInfo.sentences[Math.floor(Math.random() * levelInfo.sentences.length)];
            const prompt = `Create a multiple-choice question for a senior patient to practice saying: "${randomSentence.en}" (${randomSentence.cn}).
            Output JSON: {"doctorSaysEn": "...", "doctorSaysCn": "...", "options": [{"en": "${randomSentence.en}", "cn": "${randomSentence.cn}", "isCorrect": true}, {"en": "...", "cn": "...", "isCorrect": false}, {"en": "...", "cn": "...", "isCorrect": false}]}`;
            
            try {
                const res = await fetch(url, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) });
                if (res.status === 429) { apiRateLimitedUntil = Date.now() + 60000; return getFallbackQuiz(levelInfo); }
                const data = await res.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(text);
                if (!json.options || !Array.isArray(json.options)) return getFallbackQuiz(levelInfo);
                json.options = json.options.map(o => ({ en: String(o.en || o), cn: String(o.cn || ""), isCorrect: !!o.isCorrect }));
                return json;
            } catch (e) { return getFallbackQuiz(levelInfo); }
        }

        const getFallbackQuiz = (levelInfo) => {
            const s = levelInfo.sentences[Math.floor(Math.random() * levelInfo.sentences.length)] || {en: "I have a fever", cn: "æˆ‘ç™¼ç‡’äº†"};
            return {
                doctorSaysEn: `If you want to say "${s.cn}", how do you say it in English?`,
                doctorSaysCn: `å¦‚æœæ‚¨æƒ³èªªã€Œ${s.cn}ã€ï¼Œè‹±æ–‡è©²æ€éº¼èªªï¼Ÿ`,
                options: [{en: s.en, cn: s.cn, isCorrect: true}, {en: "I am hungry.", cn: "æˆ‘é¤“äº†ã€‚", isCorrect: false}, {en: "It is raining.", cn: "ä¸‹é›¨äº†ã€‚", isCorrect: false}].sort(()=>Math.random()-0.5)
            };
        };

        // --- React Components ---
        
        function ApiKeyModal({ isOpen, onSave }) {
            const [val, setVal] = useState("");
            if (!isOpen) return null;
            return <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl p-6 w-full max-w-md text-center"><i className="fa-solid fa-key text-4xl text-orange-600 mb-4"></i><h2 className="text-2xl font-bold mb-2">æ­¡è¿ä½¿ç”¨ï¼</h2><p className="mb-4">è«‹è¼¸å…¥ Google Gemini API Key å•Ÿç”¨åŠŸèƒ½ã€‚</p><input value={val} onChange={e=>setVal(e.target.value)} placeholder="API Key..." className="w-full p-3 border-2 rounded-xl mb-4" /><button onClick={()=>onSave(val)} className="w-full bg-orange-600 text-white py-3 rounded-xl font-bold btn-active">é–‹å§‹ä½¿ç”¨</button></div></div>;
        }

        function AudioPlayer({ text, apiKey, speed, size=24, className="" }) {
            const [loading, setLoading] = useState(false);
            const audioRef = useRef(null);
            const isChinese = /[\u4e00-\u9fa5]/.test(text);

            const play = async (e) => {
                if (e) e.stopPropagation();
                if (loading) return;
                if (isChinese) { speakWithBrowser(text, speed, 'zh-TW'); return; }
                setLoading(true);
                try {
                    const b64 = await fetchGeminiTTS(text, apiKey);
                    const bin = atob(b64); const bytes = new Uint8Array(bin.length);
                    for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    const blob = addWavHeader(bytes);
                    if (audioRef.current) { audioRef.current.src = URL.createObjectURL(blob); audioRef.current.playbackRate = speed; audioRef.current.play(); }
                } catch (e) { speakWithBrowser(text, speed, 'en-US'); }
                setLoading(false);
            };
            useEffect(() => { if(audioRef.current) audioRef.current.playbackRate = speed; }, [speed]);
            return <button onClick={play} className={`rounded-full flex items-center justify-center text-white shadow transition-colors ${loading?'bg-gray-400':'bg-orange-500 hover:bg-orange-600'} ${className}`} style={{width:size*2, height:size*2, minWidth:size*2}}>{loading?<i className="fa-solid fa-spinner fa-spin" style={{fontSize:size}}></i>:<i className="fa-solid fa-volume-high" style={{fontSize:size}}></i>}<audio ref={audioRef} className="hidden" /></button>;
        }

        function AutoPlayer({ text, apiKey, speed }) {
            const mounted = useRef(false);
            useEffect(() => {
                if (!mounted.current) {
                    mounted.current = true;
                    setTimeout(async () => {
                        try {
                            const b64 = await fetchGeminiTTS(text, apiKey);
                            const bin = atob(b64); const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
                            const audio = new Audio(URL.createObjectURL(addWavHeader(bytes))); audio.playbackRate = speed; audio.play();
                        } catch(e) { speakWithBrowser(text, speed, 'en-US'); }
                    }, 500);
                }
            }, [text]);
            return null;
        }

        function SpeedControl({ speed, setSpeed }) {
            return <div className="flex justify-center space-x-2 my-4 bg-white p-2 rounded-xl shadow mx-4">{[{l:"ğŸ¢ é¾œé€Ÿ",v:0.5},{l:"ğŸš¶ æ…¢é€Ÿ",v:0.8},{l:"ğŸƒ æ­£å¸¸",v:1.0}].map(o=><button key={o.l} onClick={()=>setSpeed(o.v)} className={`px-4 py-2 rounded-lg font-medium ${speed===o.v?'bg-orange-500 text-white':'bg-gray-100 text-gray-600'}`}>{o.l}</button>)}</div>;
        }

        function TutorMode({ onBack, apiKey }) {
            const [msgs, setMsgs] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [micOn, setMicOn] = useState(false);
            const [lang, setLang] = useState('zh-TW');
            const endRef = useRef(null);
            const recognition = useRef(null);

            useEffect(() => {
                setLoading(true);
                fetchGeminiChatResponse([], apiKey).then(res => { setMsgs([{role:'model', text:res}]); setLoading(false); });
                
                if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition.current = new Speech();
                    recognition.current.continuous = false;
                    recognition.current.onresult = e => { setInput(p => p + e.results[0][0].transcript); setMicOn(false); };
                    recognition.current.onend = () => setMicOn(false);
                }
            }, []);
            useEffect(() => endRef.current?.scrollIntoView({behavior:'smooth'}), [msgs]);

            const send = async () => {
                if (!input.trim()) return;
                const newMsg = { role: 'user', text: input };
                setMsgs(p => [...p, newMsg]); setInput(""); setLoading(true);
                const res = await fetchGeminiChatResponse([...msgs.slice(-6), newMsg], apiKey);
                setMsgs(p => [...p, { role: 'model', text: res }]); setLoading(false);
            };

            const toggleMic = () => {
                if (!recognition.current) return alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³");
                if (micOn) recognition.current.stop();
                else { recognition.current.lang = lang; recognition.current.start(); setMicOn(true); }
            };

            return (
                <div className="h-screen flex flex-col bg-gray-50">
                    <div className="bg-white p-4 shadow flex items-center justify-between z-10">
                        <button onClick={onBack} className="text-gray-500"><i className="fa-solid fa-arrow-left text-2xl"></i></button>
                        <h2 className="text-xl font-bold">AI è‹±æ–‡å®¶æ•™</h2>
                        <button onClick={()=>setLang(l=>l==='zh-TW'?'en-US':'zh-TW')} className="text-sm bg-gray-100 px-3 py-1 rounded-full"><i className="fa-solid fa-globe mr-1"></i>{lang==='zh-TW'?'è¼¸å…¥: ä¸­æ–‡':'Input: EN'}</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl p-4 shadow text-lg ${m.role==='user'?'bg-orange-500 text-white rounded-br-none':'bg-white text-gray-800 rounded-bl-none'}`}>
                                    <p className="whitespace-pre-wrap">{m.text}</p>
                                    {m.role==='model' && <div className="mt-2 flex justify-end"><AudioPlayer text={m.text} apiKey={apiKey} speed={0.9} size={18} className="!bg-gray-100 !text-gray-600" /></div>}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="flex justify-start"><div className="bg-gray-100 p-4 rounded-2xl"><i className="fa-solid fa-spinner fa-spin text-gray-400"></i></div></div>}
                        <div ref={endRef} />
                    </div>
                    <div className="bg-white p-4 shadow-up flex items-center space-x-2">
                        <button onClick={toggleMic} className={`p-4 rounded-full ${micOn?'bg-red-500 text-white animate-pulse':'bg-gray-100 text-gray-600'}`}>{micOn?<i className="fa-solid fa-microphone-slash text-xl"></i>:<i className="fa-solid fa-microphone text-xl"></i>}</button>
                        <input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder={lang==='zh-TW'?"è«‹èªªä¸­æ–‡...":"Speak English..."} className="flex-1 p-4 border rounded-full outline-none focus:border-orange-500" />
                        <button onClick={send} disabled={!input.trim()||loading} className="p-4 bg-orange-500 text-white rounded-full disabled:bg-gray-300"><i className="fa-solid fa-paper-plane text-xl"></i></button>
                    </div>
                </div>
            );
        }

        function QuizMode({ level, onBack, apiKey }) {
            const [q, setQ] = useState(null);
            const [loading, setLoading] = useState(true);
            const [feedback, setFeedback] = useState(null);
            const [speed, setSpeed] = useState(0.85);
            const [selOpt, setSelOpt] = useState(null);

            useEffect(() => { loadQ(); }, []);
            const loadQ = async () => { setLoading(true); setFeedback(null); setSelOpt(null); try{ const data = await fetchGeminiQuiz(level, apiKey); setQ(data); }catch(e){} setLoading(false); };
            const handleAns = (opt) => { setSelOpt(opt); setFeedback(opt.isCorrect ? 'correct' : 'incorrect'); };

            return (
                <div className="h-screen flex flex-col bg-gray-50">
                    <div className="bg-white p-4 shadow flex items-center justify-between"><button onClick={onBack} className="text-gray-500"><i className="fa-solid fa-arrow-left text-2xl"></i></button><h2 className="text-xl font-bold">AI é†«ç”Ÿæ¼”ç·´</h2><div className="w-8"></div></div>
                    <SpeedControl speed={speed} setSpeed={setSpeed} />
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        {loading && <div className="text-center py-10"><i className="fa-solid fa-spinner fa-spin text-4xl text-orange-500 mb-2"></i><p className="text-gray-500">AI æ€è€ƒä¸­...</p></div>}
                        {!loading && q && (
                            <>
                                <div className="flex items-start">
                                    <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 border-2 border-white shadow mr-3 shrink-0"><i className="fa-solid fa-user-doctor text-xl"></i></div>
                                    <div className="bg-white p-5 rounded-2xl rounded-tl-none shadow max-w-[85%]">
                                        <div className="flex justify-between items-start">
                                            <div><p className="text-xl font-bold text-gray-800">{q.doctorSaysEn}</p><p className="text-base text-gray-500 mt-1">{q.doctorSaysCn}</p></div>
                                            <AudioPlayer text={q.doctorSaysEn} apiKey={apiKey} speed={speed} size={20} className="mt-1 ml-2 !bg-blue-100 !text-blue-600" />
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-8 space-y-3">
                                    <p className="text-center text-gray-500 mb-2">è«‹é¸æ“‡æ­£ç¢ºçš„å›æ‡‰ï¼š</p>
                                    {q.options.map((opt, i) => (
                                        <div key={i} onClick={()=>!feedback && handleAns(opt)} className={`w-full p-4 rounded-xl border-2 transition-all flex items-center justify-between cursor-pointer bg-white ${feedback && selOpt===opt ? (opt.isCorrect?'border-green-500 bg-green-50':'border-red-500 bg-red-50') : 'border-white shadow hover:border-orange-300'}`}>
                                            <div className="flex-1"><p className={`text-lg font-bold ${feedback && selOpt===opt ? (opt.isCorrect?'text-green-800':'text-red-800') : 'text-gray-800'}`}>{opt.en}</p><p className="text-sm text-gray-500">{opt.cn}</p></div>
                                            <div onClick={e=>e.stopPropagation()}><AudioPlayer text={opt.en} apiKey={apiKey} speed={speed} size={20} className="!bg-gray-100 !text-gray-400" /></div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                        {feedback === 'correct' && <div className="text-center py-8 animate-bounce"><div className="inline-block p-4 bg-green-100 text-green-700 rounded-full mb-2"><i className="fa-solid fa-check text-2xl"></i></div><h3 className="text-2xl font-bold text-green-700">ç­”å°äº†ï¼</h3><button onClick={loadQ} className="mt-4 bg-orange-500 text-white px-8 py-3 rounded-full text-xl font-bold shadow btn-active">ä¸‹ä¸€é¡Œ <i className="fa-solid fa-chevron-right ml-2"></i></button></div>}
                        {feedback === 'incorrect' && <div className="text-center py-8"><div className="inline-block p-4 bg-red-100 text-red-700 rounded-full mb-2"><i className="fa-solid fa-xmark text-2xl"></i></div><h3 className="text-2xl font-bold text-red-700">ä¸å°å–”ï¼Œå†è©¦è©¦ï¼</h3><button onClick={()=>{setFeedback(null);setSelOpt(null)}} className="mt-4 bg-gray-500 text-white px-8 py-3 rounded-full text-xl font-bold shadow btn-active">é‡é¸ä¸€æ¬¡</button></div>}
                    </div>
                    {feedback === 'correct' && selOpt && <AutoPlayer text={selOpt.en} apiKey={apiKey} speed={speed} />}
                </div>
            );
        }

        function LearnMode({ level, onBack, apiKey }) {
            const [tab, setTab] = useState('vocab');
            const [speed, setSpeed] = useState(0.85);
            return (
                <div className="pb-24">
                    <div className="sticky top-0 bg-white shadow z-10 px-4 py-4 flex items-center"><button onClick={onBack} className="text-gray-600"><i className="fa-solid fa-arrow-left text-2xl"></i></button><h2 className="text-xl font-bold ml-3 text-gray-800 flex-1 truncate">{level.title}</h2></div>
                    <div className="flex p-4 space-x-4"><button onClick={()=>setTab('vocab')} className={`flex-1 py-3 rounded-2xl text-xl font-bold ${tab==='vocab'?'bg-orange-100 text-orange-700 ring-2 ring-orange-500':'bg-white border text-gray-500'}`}>å–®å­—å¡</button><button onClick={()=>setTab('sentences')} className={`flex-1 py-3 rounded-2xl text-xl font-bold ${tab==='sentences'?'bg-orange-100 text-orange-700 ring-2 ring-orange-500':'bg-white border text-gray-500'}`}>å¥å­</button></div>
                    <SpeedControl speed={speed} setSpeed={setSpeed} />
                    <div className="px-4 space-y-4">
                        {tab==='vocab' ? level.vocab.map((v,i)=>(<div key={i} className="bg-white p-6 rounded-3xl shadow flex justify-between items-center"><div className="flex-1"><span className="px-2 py-1 bg-gray-100 text-xs rounded text-gray-500 mb-1 inline-block">{v.category}</span><h3 className="text-4xl font-bold text-gray-800">{v.en}</h3><p className="text-gray-500 font-mono">{v.kk}</p><p className="text-2xl text-orange-700">{v.cn}</p></div><AudioPlayer text={v.en} apiKey={apiKey} speed={speed} /></div>))
                        : level.sentences.map((s,i)=>(<div key={i} className="bg-white p-6 rounded-3xl shadow"><div className="flex justify-between items-start mb-2"><span className="px-2 py-1 bg-blue-50 text-blue-600 text-xs rounded"><i className="fa-solid fa-tag mr-1"></i>{s.context}</span><AudioPlayer text={s.en} apiKey={apiKey} speed={speed} /></div><h3 className="text-2xl font-bold text-gray-800 mb-1">{s.en}</h3><p className="text-xl text-gray-600">{s.cn}</p></div>))}
                    </div>
                </div>
            );
        }

        function App() {
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_key") || "");
            const [view, setView] = useState("home");
            const [level, setLevel] = useState(null);
            const saveKey = (k) => { setApiKey(k); localStorage.setItem("gemini_key", k); };
            const selLevel = (l) => { setLevel(l); setView("level-menu"); };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#FFF5F5] shadow-2xl relative overflow-hidden">
                    <ApiKeyModal isOpen={!apiKey} onSave={saveKey} />
                    {apiKey && (
                        <>
                            {view === "home" && (
                                <>
                                    <div className="bg-orange-600 text-white p-6 rounded-b-3xl shadow mb-2 flex justify-between items-center"><div><h1 className="text-2xl font-bold">æ—©å®‰ï¼Good Morning</h1><p className="opacity-90">é†«ç™‚è‹±èªå°åŠ©æ‰‹</p></div><div className="w-12 h-12 bg-white/20 rounded-full flex justify-center items-center text-2xl"><i className="fa-solid fa-user"></i></div></div>
                                    <div className="p-4 space-y-6">
                                        <h1 className="text-center text-3xl font-bold text-gray-800 mt-4 mb-4">è«‹é¸æ“‡èª²ç¨‹</h1>
                                        {Object.values(LEVELS).map(l => (<div key={l.id} onClick={()=>selLevel(l)} className={`${l.color} text-white p-6 rounded-3xl shadow active:scale-95 transition cursor-pointer flex justify-between items-center`}><div><h2 className="text-3xl font-bold mb-1">{l.title.split(":")[1]}</h2><p className="text-white/90 text-lg">{l.subTitle}</p></div><i className="fa-solid fa-chevron-right text-2xl opacity-80"></i></div>))}
                                        <div onClick={()=>setView('tutor')} className="bg-indigo-600 text-white p-6 rounded-3xl shadow active:scale-95 transition cursor-pointer flex justify-between items-center mt-8"><div><h2 className="text-3xl font-bold mb-1">AI è‹±æ–‡å®¶æ•™</h2><p className="text-white/90 text-lg">ä¸€å°ä¸€å°è©±ç·´ç¿’</p></div><div className="bg-white/20 p-3 rounded-full"><i className="fa-solid fa-comments text-2xl"></i></div></div>
                                    </div>
                                    <div className="text-center text-gray-400 mt-8 text-sm p-4">Designed for Seniors in Canada ğŸ‡¨ğŸ‡¦</div>
                                </>
                            )}
                            {view === "level-menu" && level && (
                                <div className="h-screen flex flex-col p-6">
                                    <button onClick={()=>setView("home")} className="self-start text-gray-500 mb-6"><i className="fa-solid fa-arrow-left text-xl mr-1"></i>å›é¦–é </button>
                                    <h2 className="text-3xl font-bold text-gray-800 mb-2">{level.title}</h2><p className="text-gray-500 mb-8 text-lg">{level.subTitle}</p>
                                    <div className="space-y-4 flex-1">
                                        <button onClick={()=>setView("learn")} className="w-full bg-white p-8 rounded-3xl shadow flex items-center space-x-6 active:scale-95 transition"><div className="w-16 h-16 bg-orange-100 rounded-2xl flex justify-center items-center text-orange-600 text-3xl"><i className="fa-solid fa-book-open"></i></div><div className="text-left"><h3 className="text-2xl font-bold text-gray-800">å–®å­—èˆ‡å¥å­</h3><p className="text-gray-500 text-lg">åŸºç¤ç·´ç¿’</p></div></button>
                                        <button onClick={()=>setView("quiz")} className="w-full bg-white p-8 rounded-3xl shadow flex items-center space-x-6 active:scale-95 transition"><div className="w-16 h-16 bg-blue-100 rounded-2xl flex justify-center items-center text-blue-600 text-3xl"><i className="fa-solid fa-comments"></i></div><div className="text-left"><h3 className="text-2xl font-bold text-gray-800">AI é†«ç”Ÿæ¼”ç·´</h3><p className="text-gray-500 text-lg">æƒ…å¢ƒå°è©±æ¸¬è©¦</p></div></button>
                                    </div>
                                </div>
                            )}
                            {view === "learn" && <LearnMode level={level} onBack={()=>setView("level-menu")} apiKey={apiKey} />}
                            {view === "quiz" && <QuizMode level={level} onBack={()=>setView("level-menu")} apiKey={apiKey} />}
                            {view === "tutor" && <TutorMode onBack={()=>setView("home")} apiKey={apiKey} />}
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
